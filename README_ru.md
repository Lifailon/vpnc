<p align="center">
  <img title="Ping Not Available"src="img/ping-not-available.png">
  <img title="next"src="img/next.png">
  <img title="Ping Available"src="img/ping-available.png">
  <img title="next"src="img/next.png">
  <img title="Ping Not Available"src="img/vpn.png">
</a>

<h1 align="center">
    vpnc - VPN Control
</h1>

<h4 align="center">
    <a href="README.md">English</a> | <strong>Русский</strong>
</h4>

Универсальный инструмент для автоматического (локального) и удаленного управления VPN соединением через настольное приложение (системный трей) и `API`.

Фактически данный инструмент может выступать как `API` для управления запуском и остановкой любых процессов в удаленной системе Windows.

- [Для чего](#для-чего)
- [Функционал](#функционал)
- [Установка и сборка](#установка-и-сборка)
- [Конфигурация](#конфигурация)
- [Использование](#использование)
- [API](#api)
  - [Получить статус](#получить-статус)
  - [Запуск процесса](#запуск-процесса)
  - [Остановка процесса](#остановка-процесса)
- [Backlog](#backlog)
- [Альтернативы](#альтернативы)

## Для чего

Мне надоело, что приложение [Hotspot Shield](https://hotspotshield.com/vpn/vpn-for-windows) или [ProtonVPN](https://github.com/ProtonVPN/win-app) может периодически разрывать VPN соединение, чаще всего это происходит из за долгого подключения к сети VPN (несколько десятков часов) или продолжительного отсуствия подключения к сети Интернет. В таком случае, даже если включена настройка автоматического переподключения, соединение может быть не установлено повторно, или это может быть расценено приложением как ручное отключение.

Данное приложение выполняет ровно три функции - завершает процесс по имени и запускает процесс по пути, которые указаны в конфигурационном файле или переданы в параметрах через `API`, а также собирает статистику для достоверной проверки VPN соединения и доступности сети Интернет.

По мимо этого, такой подход может быть полезен, если нужно удаленно отключить VPN-соединение на время загрузки большого объема траффика на целевой машине, а также позволяет котролировать данное соединение. Данный функционал интегрирован в проект [Kinozal-Bot](https://github.com/Lifailon/Kinozal-Bot) в версии `0.4.7` для удаленного управления процессами через **Telegram бота**.

## Функционал

![interface](/img/interface.jpg)

- Интерфейс `API`, который позволяет настроить удаленное управление VPN соединением на целевом хосте. Например, в моей сети это выделенная машина, где доступ к конкретному контенту с других машин осуществляется по средствам Proxy (например, [froxy](https://github.com/Lifailon/froxy)), это удобно, что бы не ограничивать весь траффик к сети Интернет VPN соединением и при этом не ограничиваться раздельным туннелированием к сети VPN.

- Мониторинг доступности Интернет соединения. Проверка производится каждые 5 секунд (по умолчанию, можно изменить в конфигурационном файле), в случае если соединение будет недоступно, придет системное уведомление (а также изменится статус иконки приложения) и проверка будет производиться каждые две секунды до момента стабильного восстановления соединения (3 успешных `icmp` запроса подряд с интервалом 2 секунды), после чего придет повторное уведомление.

- Мониторинг доступности и автоматическое восстановление VPN соединения. Если Интернет доступен а также процесс VPN запущен (исключая ручное завершение), но при этом сетевой VPN интерфейс находится в выключенном состоянии, будет производиться автоматический перезапуск приложения для переподключения к сети VPN до момента восстановления соединения (по умолчанию, каждые 120 секунд, можно изменить в конфигурационном файле).

- Запись истории пингов и запросов к `API` в лог-файле.

Такой подход является универсальным, по этому это может и будет работать с любым VPN приложением. Единственным условием для работоспособности данного метода является возможность вашего VPN клиента автоматически подключаться к сети VPN при запуске приложения (поддерживает большенство клиентов).

## Установка и сборка

Портативная версия приложения доступна на вкладке [релизов](https://github.com/Lifailon/vpnc/releases/latest).

Необходимо, что бы в системе была установлена платформа [.NET Runtime 8.0](https://dotnet.microsoft.com/en-us/download/dotnet/8.0) для запуска .NET приложений.

Для сборки приложения клонируйте репозиторий и установите зависимости:

```shell
git clone https://github.com/Lifailon/vpnc
cd vpnc
dotnet build
dotnet publish
```

Что бы исключить установки **.NET Runtime** на целевой системе, включите его в сборку:

```shell
dotnet publish -c Release -r win-x64 -p:PublishSingleFile=true --self-contained true
```

Используемые пакеты:

```shell
dotnet add package Newtonsoft.Json
dotnet add package Microsoft.AspNetCore.App
dotnet add package Swashbuckle.AspNetCore
```

## Конфигурация

Для быстрого доступа к конфигурации, используется кнопка **Open Configuration** в контекстном меню трея. Конфигурация располагается в файле `vpnc.json`, рядом с исполняемым файлом.

Пример конфигурации:

```json
{
    "ProcessName": "ProtonVPN",
    "ProcessPath": "C:\\Program Files\\Proton\\VPN\\v3.4.3\\ProtonVPN.exe",
    "InterfaceName": "ProtonVPN TUN",
    "ApiPort": 1780,
    "ApiKey": "b1f8e72d-9c34-4a2e-a5f1-3d57b2a1c7f8",
    "PingHost": "8.8.8.8",
    "PingLog": true,
    "PingStartup": true,
    "VpnStartup": false,
    "ApiStartup": true,
    "PingTimeout": 5,
    "VpnTimeout": 5,
    "VpnRestartTimeout": 120
}
```

Описание параметров:

- `ProcessName` - Название процесса, которое необходимо завершать. Чаще всего это название соотвествует исполняемому файлу, его также можно определить в диспетчере задач Windows.
- `ProcessPath` - Полный путь до исполняемого файла, который отвечает за запуск VPN клиента.
- `InterfaceName` - Название виртуального VPN интерфейса (создается автоматически при установке VPN клиента). Что бы определить имя интерфейса, можно воспользоваться классической командой `ipconfig`.
- `ApiPort` - Порт, на котором будет запущен интерфейс `Web/REST API`.
- `ApiKey` - Ключ для доступа к конечным точками `API` (доступ в Swagger разрешен без ключа, а также добавлена авторизации через интерфейс).
- `PingHost` - Адрес, который будет выступать узлом для проверки доступности Интернет соединения.
- `PingLog` - Включить запись пингов в лог файл.
- `PingStartup/VpnStartup/ApiStartup` - Определяет начальное состояние при запуске интерфейса. Принимает булевое значение `true` или `false`.
- `PingTimeout/VpnTimeout` - Периодичность автоматических проверок в секундах.
- `VpnRestartTimeout` - Задержка до повторного перезапуска процесса (работает, только когда `"VpnStartup": false`) в секундах.

Что бы быстро определить все параметры, используйте `PowerShell`:

```PowerShell
# Название процесса по частичному совпадению в названии
Get-Process *protonvpn*
# Путь к исполняемому файлу по имени процесса
Get-Process *protonvpn* | Select-Object *path*
# Имя сетевого адаптера
$(Get-NetIPConfiguration | Where-Object InterfaceAlias -match "hotspot").InterfaceAlias
```

Остальные параметры можно оставить по умолчанию. Для применения настроект, необходимо перезапустить приложение.

## Использование

Запустите приложение в режиме командной строки:

```shell
dotnet run [start|stop|status|api|tray|process]
```

Параметр `process` используется для запуска приложения в режиме фонового процесса для управления через системный трей (аналогично `vpnc.exe tray`).

Для запуска программы при загрузке системы, перейдите в директорию автозапуска (`Win+R` - `shell:startup`):

```
%USERNAME%\AppData\Roaming\Microsoft\Windows\Start Menu\Programs\Startup
```

Создайте в корне директории `Startup` ярлык с содержимым: 

```
"C:\Users\<UserName>\Documents\vpnc\vpnc.exe" process
```

Замените путь расположения исполняемого файла на свой. Если для завершения процессов требуются повышенные права, в свойствах ярлыка выберите `Совместимость` и включите `Запускать эту программу от имени администратора`.

## API

Интерфейс `API` возможно запустить в режиме командной строки (cli), или из контекстного меню приложения в трее. Автоматическое включение `API` при запуске приложения определяется параметром `ApiStartup` в конфигурационном файле.

Документация **Swagger** доступна через библиотеку `Swashbuckle.AspNetCore` по адресу: http://localhost:1780/swagger

![swagger](/img/swagger.jpg)

### Получить статус

`curl -s http://192.168.3.100:1780/api/status -H 'X-API-KEY: b1f8e72d-9c34-4a2e-a5f1-3d57b2a1c7f8' | jq`

```json
{
  "processName": "ProtonVPN",
  "processStatus": "Running",
  "processUptime": "0.0:8:2",
  "systemUptime": "3.0:33:21",
  "interfaceName": "ProtonVPN TUN",
  "interfaceStatus": "Up",
  "pingAddress": "8.8.8.8",
  "pingStatus": "Connected",
  "pingTimeout": "94 ms",
  "country": "RO",
  "timeZone": "Europe/Bucharest",
  "region": "București",
  "city": "Bucharest",
  "externalIp": "185.XXX.XXX.XXX"
}
```

Для получения данных о внешнем соединение (которое отвечает за выход в Интернет), используется сервис [ipinfo](https://ipinfo.io).

### Запуск процесса

```shell
curl -X 'POST' 'http://192.168.3.100:1780/api/start' \
  -H 'X-API-KEY: b1f8e72d-9c34-4a2e-a5f1-3d57b2a1c7f8' \
  -H 'path: C:\Program Files\Proton\VPN\v3.4.3\ProtonVPN.exe' \
  -d ''
```

При запуске производится проверка переданного параметра, доступности пути и что процесс был запущен.

### Остановка процесса

```shell
curl -X 'POST' 'http://192.168.3.100:1780/api/stop' \
  -H 'X-API-KEY: b1f8e72d-9c34-4a2e-a5f1-3d57b2a1c7f8' \
  -H 'name: ProtonVPN' \
  -H 'wildcard: true' \
  -d ''
```

Параметр `wildcard` используется для остановки всех процессов по частичному совпадению в переданном названии.

## Backlog

На текущий момент данный функционал покрывает мои потребности, но есть несколько вещей, которые в будущем возможно будут реализованы.

- [ ] Универсальный поиск процесса по его имени в системе
- [ ] Статусы пингов в системном трее
- [ ] Получить список процессов и служб с информацией статуса работы
- [ ] Управление службами
- [ ] Новые конечные точки для получения информации о системе (системные метрики)

## Альтернативы

[WinAPI](https://github.com/Lifailon/WinAPI) - `REST API` и Web-сервер (frontend) на базе `.NET HttpListener` и backend `PowerShell Core` для удаленного управления операционной системой Windows чере веб браузер или любой `API` клиент, например, `curl` из Linux.
